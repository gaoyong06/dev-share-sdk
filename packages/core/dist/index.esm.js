class t{constructor(t){this.memoryStorage=new Map,this.config=t}getToken(){if(this.config.customTokenGetter)return this.config.customTokenGetter();if("undefined"==typeof window)return null;const t=this.config.tokenKey||"access_token",e=this.getStorage();return e?e.getItem(t):null}setToken(t){if(this.config.customTokenSetter)return void this.config.customTokenSetter(t);if("undefined"==typeof window)return;const e=this.config.tokenKey||"access_token",s=this.getStorage();s&&s.setItem(e,t)}clearToken(){if("undefined"==typeof window)return;const t=this.config.tokenKey||"access_token",e=this.getStorage();e&&e.removeItem(t)}getStorage(){if("undefined"==typeof window)return null;switch(this.config.tokenStorage||"localStorage"){case"localStorage":return window.localStorage;case"sessionStorage":return window.sessionStorage;case"memory":return this.getMemoryStorage();default:return null}}getMemoryStorage(){return{getItem:t=>this.memoryStorage.get(t)||null,setItem:(t,e)=>this.memoryStorage.set(t,e),removeItem:t=>this.memoryStorage.delete(t),clear:()=>this.memoryStorage.clear(),length:this.memoryStorage.size,key:t=>Array.from(this.memoryStorage.keys())[t]||null}}}function e(t,e){if(!1===t.success||t.errorCode&&!0!==t.success){let s=0;if(t.errorCode){const e=parseInt(t.errorCode,10);s=isNaN(e)?0:e}else e>=400&&(s=e);return{code:s,message:t.errorMessage||t.message||(t.error&&"string"==typeof t.error?t.error:null)||("string"==typeof t?t:null)||"请求失败",details:t}}if(void 0!==t.code&&0!==t.code){const e=t.message||(t.error&&"string"==typeof t.error?t.error:null)||("string"==typeof t?t:null)||"请求失败";return{code:t.code,message:e,details:t}}return{code:e,message:t.errorMessage||t.message||(t.error&&"string"==typeof t.error?t.error:null)||("string"==typeof t?t:null)||`请求失败 (HTTP ${e})`,details:t}}class s{constructor(e){this.config=e,this.authManager=new t(e)}async request(t,s={}){try{const{params:n,appId:r,headers:a,...o}=s,i=new URLSearchParams;r?i.append("appId",r):this.config.appId&&i.append("appId",this.config.appId),n&&Object.entries(n).forEach(([t,e])=>{null!=e&&i.append(t,String(e))});let c=t;i.toString()&&(c=`${t}?${i.toString()}`);const p=this.config.baseURL||"http://localhost:9080",l=this.config.useProxy||!1,u=this.config.apiProxy||"/api/proxy",d=l?`${u}?path=${encodeURIComponent(c)}`:`${p}${c}`,h=this.authManager.getToken(),g=this.config.apiKey,y={"Content-Type":"application/json",...h&&{Authorization:`Bearer ${h}`},...g&&{"X-API-Key":g},...a};let f,$;try{f=await fetch(d,{...o,headers:y})}catch(t){const e=t instanceof Error?t.message:"网络请求失败",s=e.includes("CORS")||e.includes("cors")||e.includes("Failed to fetch")||e.includes("NetworkError");return{error:{code:s?-1:0,message:s?`CORS 错误: 无法访问 ${d}。请检查 CORS 配置。`:`网络错误: ${e}`,details:{url:d,originalError:e}}}}if(!f.ok&&0===f.status){return{error:{code:-1,message:`CORS 错误: 无法访问 ${d}。请检查 CORS 配置。`,details:{url:d,status:f.status}}}}try{$=await f.json()}catch(t){return{error:{code:f.status||0,message:t instanceof Error?t.message:"响应格式错误",details:{url:d,status:f.status}}}}!0===$.success||$.success;const I=$.errorCode&&""!==$.errorCode&&"0"!==$.errorCode;return!1===$.success||"false"===$.success||I&&0!==parseInt($.errorCode)||!f.ok&&f.status>=400?{error:e($,f.status)}:{data:void 0!==$.data?$.data:$}}catch(t){return{error:{code:0,message:t instanceof Error?t.message:"网络错误"}}}}async get(t,e){return this.request(t,{...e,method:"GET"})}async post(t,e,s){return this.request(t,{...s,method:"POST",body:e?JSON.stringify(e):void 0})}async put(t,e,s){return this.request(t,{...s,method:"PUT",body:e?JSON.stringify(e):void 0})}async delete(t,e){return this.request(t,{...e,method:"DELETE"})}async uploadFile(t,s,n,r){try{const a=new FormData;a.append("file",s),n&&Object.entries(n).forEach(([t,e])=>{a.append(t,e)});const o=this.config.baseURL||"http://localhost:9080",i=this.config.useProxy||!1,c=this.config.apiProxy||"/api/proxy",p=i?`${c}?path=${encodeURIComponent(t)}`:`${o}${t}`,l=this.authManager.getToken(),u=this.config.apiKey;let d;if(console.log("[SDK] uploadFile: START - options:",r,"config.appId:",this.config.appId,"type:",typeof this.config.appId),r?.appId&&(console.log("[SDK] uploadFile: options.appId exists:",r.appId,"type:",typeof r.appId),"string"==typeof r.appId?(d=r.appId,console.log("[SDK] uploadFile: using options.appId (string):",d)):console.error("[SDK] uploadFile: options.appId is not a string:",r.appId,"type:",typeof r.appId,"toString:",String(r.appId))),!d&&this.config.appId)if(console.log("[SDK] uploadFile: config.appId exists:",this.config.appId,"type:",typeof this.config.appId),"string"==typeof this.config.appId)d=this.config.appId,console.log("[SDK] uploadFile: using config.appId (string):",d);else{console.error("[SDK] uploadFile: config.appId is not a string:",this.config.appId,"type:",typeof this.config.appId,"toString:",String(this.config.appId));const t=String(this.config.appId);t&&"[object Object]"!==t&&t.length>10&&(d=t,console.log("[SDK] uploadFile: converted config.appId to string:",d))}const h=new URLSearchParams;console.log("[SDK] uploadFile: appIdString before validation:",d,"type:",typeof d),d&&"string"==typeof d&&d.length>10?"[object Object]"===d||d.includes("object")?console.error("[SDK] uploadFile: appIdString is invalid (contains object):",d):(h.append("appId",d),console.log("[SDK] uploadFile: appId added to query params:",d)):console.warn("[SDK] uploadFile: no valid appId found, appIdString:",d,"options.appId:",r?.appId,"config.appId:",this.config.appId);const g=h.toString()?`${p}${p.includes("?")?"&":"?"}${h.toString()}`:p,y={};if(l&&(y.Authorization=`Bearer ${l}`),u&&(y["X-API-Key"]=u),r?.headers){const t=r.headers;Object.entries(t).forEach(([t,e])=>{const s=t.toLowerCase();"content-type"!==s&&"contenttype"!==s&&(y[t]=e)})}let f,$;try{f=await fetch(g,{method:"POST",body:a,headers:Object.keys(y).length>0?y:void 0})}catch(t){const e=t instanceof Error?t.message:"网络请求失败";return{error:{code:-1,message:`网络错误: ${e}`,details:{url:g,originalError:e}}}}if(!f.ok&&0===f.status)return{error:{code:-1,message:`CORS 错误: 无法访问 ${g}`,details:{url:g,status:f.status}}};try{$=await f.json()}catch(t){return{error:{code:f.status||0,message:t instanceof Error?t.message:"响应格式错误",details:{url:g,status:f.status}}}}return!1===$.success||$.errorCode&&!0!==$.success||(void 0!==$.code&&0!==$.code||!f.ok&&f.status>=400)?{error:e($,f.status)}:{data:void 0!==$.data&&null!==$.data?$.data:$}}catch(t){return{error:{code:0,message:t instanceof Error?t.message:"文件上传失败"}}}}}function n(t){try{const e=t.split(".");if(3!==e.length)return null;const s=e[1],n=s+"=".repeat((4-s.length%4)%4),r=atob(n.replace(/-/g,"+").replace(/_/g,"/")),a=JSON.parse(r);return a.userId&&"string"==typeof a.userId?a.userId:null}catch(t){return console.error("Failed to parse JWT token:",t),null}}function r(t){if("undefined"==typeof window)return null;const e=(t||(()=>"undefined"!=typeof window?localStorage.getItem("access_token"):null))();return e?n(e):null}function a(t){if("undefined"==typeof window)return null;const e=t?.tokenGetter||(()=>localStorage.getItem("access_token")),s=t?.userGetter||(()=>localStorage.getItem("user")),n=t?.userIdGetter||(()=>localStorage.getItem("user_id")),a=t?.clearCache||(()=>{localStorage.removeItem("user"),localStorage.removeItem("user_id")});if(!e())return a(),null;const o=r(e),i=s(),c=n();if(!o||c&&c!==o)return console.warn("Cached user info does not match token, clearing cache"),a(),null;if(i&&c===o)try{const t=JSON.parse(i);return t.userId&&t.userId===o?t:(a(),null)}catch{return a(),null}return null}function o(t){if("undefined"==typeof window)return;(t?.clearCache||(()=>{localStorage.removeItem("user"),localStorage.removeItem("user_id")}))()}function i(t,e){if("undefined"==typeof window)return;const s=e?.userSetter||(t=>{localStorage.setItem("user",JSON.stringify(t))}),n=e?.userIdSetter||(t=>{localStorage.setItem("user_id",t)});s(t),n(t.userId)}function c(t){if("undefined"==typeof window)return!1;return!!(t||(()=>localStorage.getItem("access_token")))()}const p="/v1";class l{constructor(t,e){this.client=t,this.defaultAppId=e}async register(t,e){return this.client.post(`${p}/auth/register`,t,{appId:e||this.defaultAppId})}async login(t,e){return this.client.post(`${p}/auth/login`,t,{appId:e||this.defaultAppId})}async logout(t){return this.client.post(`${p}/auth/logout`,t)}async sendCaptcha(t,e){return this.client.post(`${p}/auth/captcha`,t,{appId:e||this.defaultAppId})}async verifyCaptcha(t){return this.client.post(`${p}/auth/captcha/verify`,t)}async resetPassword(t){return this.client.post(`${p}/auth/password/reset`,t)}async validateToken(t){return this.client.post(`${p}/auth/token/validate`,{token:t})}async createGuest(t,e){return this.client.post(`${p}/auth/guest`,t,{appId:e||this.defaultAppId})}async getUser(t){return this.client.get(`${p}/users/${t}`)}async batchGetUsers(t){return this.client.post(`${p}/users/batch`,t)}async listUsers(t,e){return this.client.get(`${p}/users`,{params:{...t},appId:e||this.defaultAppId})}async getUserStats(t){return this.client.get(`${p}/users/stats`,{appId:t||this.defaultAppId})}async updateProfile(t){const{userId:e,...s}=t;return this.client.put(`${p}/users/${e}`,s)}async updateUserStatus(t){const{userId:e,...s}=t;return this.client.put(`${p}/users/${e}/status`,s)}async addToBlacklist(t,e){const{userId:s,...n}=t;return this.client.post(`${p}/users/${s}/blacklist`,n,{appId:e||this.defaultAppId})}async removeFromBlacklist(t,e){return this.client.delete(`${p}/users/${t}/blacklist`,{appId:e||this.defaultAppId})}async batchAddToBlacklist(t,e){return this.client.post(`${p}/users/blacklist/batch`,t,{appId:e||this.defaultAppId})}async getLocationByIP(t){return this.client.post(`${p}/geoip/location`,t)}}const u="/api/v1/files";class d{constructor(t){this.client=t}async uploadFile(t,e,s){return this.client.uploadFile("/api/v1/files/upload",t,e,{appId:s})}async downloadFile(t){const e=await this.getFileURL(t);return e.error,e}async getFileInfo(t){return this.client.get(`${u}/${t}`)}async getFileURL(t,e){return this.client.get(`${u}/${t}/url`,{params:e?{expireSeconds:e}:void 0})}async deleteFile(t){return this.client.delete(`${u}/${t}`)}async listFiles(t,e){return this.client.get(u,{params:t,appId:e})}}const h="/v1/notification";class g{constructor(t){this.client=t}async send(t){return this.client.post(`${h}/send`,t)}async batchSend(t){return this.client.post(`${h}/batch-send`,t)}async getStatus(t){return this.client.get(`${h}/status/${t}`)}async getHistory(t,e){return this.client.get(`${h}/history/${t}`,{params:e})}async saveTemplate(t){return this.client.post(`${h}/template`,t)}async listTemplates(t){return this.client.get(`${h}/templates`,{params:t})}async setUserPreference(t){return this.client.post(`${h}/preference`,t)}async getUserPreference(t){return this.client.get(`${h}/preference/${t}`)}}const y="/v1/subscription";class f{constructor(t){this.client=t}async listPlans(t){return this.client.get(`${y}/plans`,{appId:t})}async createPlan(t,e){return this.client.post(`${y}/plans`,t,{appId:e})}async updatePlan(t){const{planId:e,...s}=t;return this.client.put(`${y}/plans/${e}`,s)}async deletePlan(t){return this.client.delete(`${y}/plans/${t}`)}async listPlanPricings(t){return this.client.get(`${y}/plans/${t}/pricings`)}async createPlanPricing(t){const{planId:e,...s}=t;return this.client.post(`${y}/plans/${e}/pricings`,s)}async updatePlanPricing(t){const{planPricingId:e,...s}=t;return this.client.put(`${y}/pricings/${e}`,s)}async deletePlanPricing(t){return this.client.delete(`${y}/pricings/${t}`)}async createSubscriptionOrder(t){const{region:e,...s}=t;return this.client.post(`${y}/order`,s)}async getMySubscription(t){const{userId:e}=t;return this.client.get(`${y}/my/${e}`)}async cancelSubscription(t){return this.client.post(`${y}/cancel`,t)}async pauseSubscription(t){return this.client.post(`${y}/pause`,t)}async resumeSubscription(t){return this.client.post(`${y}/resume`,t)}async getSubscriptionHistory(t){const{userId:e,...s}=t;return this.client.get(`${y}/history/${e}`,{params:s})}async setAutoRenew(t){return this.client.post(`${y}/auto-renew`,t)}async listSubscriptionOrders(t){const{appId:e,...s}=t;return this.client.get(`${y}/orders`,{params:s,appId:e})}async getSubscriptionOrder(t){const{orderId:e}=t;return this.client.get(`${y}/orders/${e}`)}async listAppSubscriptions(t){const{appId:e,...s}=t;return this.client.get(`${y}/app/subscriptions`,{params:s,appId:e})}async getAppSubscriptionHistory(t){const{appId:e,...s}=t;return this.client.get(`${y}/app/history`,{params:s,appId:e})}}const $="/v1";class I{constructor(t,e){this.client=t,this.defaultAppId=e}async createPayment(t){return this.client.post(`${$}/payment`,t)}async getPayment(t){const{paymentId:e,orderId:s}=t;return e?this.client.get(`${$}/payment/${e}`):s?this.client.get(`${$}/payment/order/${s}`):{error:{code:400,message:"Either paymentId or orderId must be provided"}}}async refundPayment(t){return this.client.post(`${$}/payment/refund`,t)}async getRevenueStats(t){return this.client.get(`${$}/revenue/stats`,{appId:t||this.defaultAppId})}async getAppRevenueStats(t){return this.client.get(`${$}/revenue/app`,{appId:t||this.defaultAppId})}async listTransactions(t,e){return this.client.get(`${$}/transactions`,{params:t,appId:e||this.defaultAppId})}}const m="/v1";class S{constructor(t){this.client=t}async createCoupon(t,e){return this.client.post(`${m}/coupons`,t,{appId:e})}async getCoupon(t){const{couponCode:e}=t;return this.client.get(`${m}/coupons/${e}`)}async listCoupons(t,e){return this.client.get(`${m}/coupons`,{params:t,appId:e})}async updateCoupon(t){const{couponCode:e,...s}=t;return this.client.put(`${m}/coupons/${e}`,s)}async deleteCoupon(t){const{couponCode:e}=t;return this.client.delete(`${m}/coupons/${e}`)}async validateCoupon(t){return this.client.post(`${m}/coupons/validate`,t)}async useCoupon(t){return this.client.post(`${m}/coupons/use`,t)}async getCouponStats(t){const{couponCode:e}=t;return this.client.get(`${m}/coupons/${e}/stats`)}async listCouponUsages(t){const{couponCode:e,...s}=t;return this.client.get(`${m}/coupons/${e}/usages`,{params:s})}async getCouponsSummaryStats(t){const{appId:e}=t;return this.client.get(`${m}/coupons/summary-stats`,{appId:e})}}const w="/api/v1/apps";class C{constructor(t){this.client=t}async createApp(t){return this.client.post(w,t)}async listApps(t){const{user_id:e,...s}=t;return this.client.get(w,{params:{user_id:e,...s}})}async getApp(t){return this.client.get(`${w}/${t}`)}async updateApp(t){const{appId:e,...s}=t;return this.client.put(`${w}/${e}`,s)}async deleteApp(t){return this.client.delete(`${w}/${t}`)}}const k="/api/v1/short-link";class v{constructor(t){this.client=t}async createShortLink(t){return this.client.post(`${k}`,t)}async getShortLink(t){return this.client.get(`${k}/${t}`)}async listShortLinks(t){return this.client.get(`${k}s`,{params:{userId:t.userId,page:t.page,pageSize:t.pageSize,...t.groupId&&{groupId:t.groupId},...t.tags&&{tags:t.tags},...t.search&&{search:t.search}}})}async batchCreateShortLinks(t){return this.client.post(`${k}s/batch`,t)}async updateShortLink(t){const{shortCode:e,...s}=t;return this.client.put(`${k}/${e}`,s)}async getShortLinkStats(t){return this.client.get(`${k}/${t.shortCode}/stats`,{params:{startDate:t.startDate,endDate:t.endDate}})}async getRealTimeStats(t){return this.client.get(`${k}/${t.shortCode}/realtime-stats`,{params:{minutes:t.minutes||60}})}async getTrendStats(t){return this.client.get(`${k}/${t.shortCode}/trend-stats`,{params:{startDate:t.startDate,endDate:t.endDate,period:t.period}})}async getSourceAnalysis(t){return this.client.get(`${k}/${t.shortCode}/source-analysis`,{params:{startDate:t.startDate,endDate:t.endDate}})}async getUserProfile(t){return this.client.get(`${k}/${t.shortCode}/user-profile`,{params:{startDate:t.startDate,endDate:t.endDate}})}async getFunnelAnalysis(t){return this.client.get(`${k}/${t.shortCode}/funnel-analysis`,{params:{startDate:t.startDate,endDate:t.endDate}})}async createGroup(t){return this.client.post(`${k}-groups`,t)}async listGroups(t){return this.client.get(`${k}-groups`,{params:{userId:t.userId}})}async searchTags(t){return this.client.get(`${k}-tags`,{params:{userId:t.userId,...t.query&&{query:t.query},...t.limit&&{limit:t.limit}}})}async generateQRCode(t){return this.client.get(`${k}/${t.shortCode}/qrcode`,{params:{size:t.size||256,errorCorrectionLevel:t.errorCorrectionLevel||"M"}})}}class b{constructor(t){this.config=t,this.client=new s(t),this.passport=new l(this.client,t.appId),this.asset=new d(this.client),this.notification=new g(this.client),this.subscription=new f(this.client),this.payment=new I(this.client,t.appId),this.marketing=new S(this.client),this.app=new C(this.client),this.shortLink=new v(this.client)}getConfig(){return{...this.config}}updateConfig(t){this.config={...this.config,...t},this.client=new s(this.config),this.passport=new l(this.client,this.config.appId),this.payment=new I(this.client,this.config.appId)}}export{C as AppService,d as AssetService,b as AtSeekerSDK,t as AuthManager,S as MarketingService,g as NotificationService,l as PassportService,I as PaymentService,s as RequestClient,v as ShortLinkService,f as SubscriptionService,c as checkHasToken,o as clearUserCache,b as default,r as getUserIdFromToken,e as parseError,n as parseUserIdFromToken,i as saveUserCache,a as validateAndGetCachedUser};
//# sourceMappingURL=index.esm.js.map
